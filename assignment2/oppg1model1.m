% number of observations and unknowns
n = 21;
e = 6;

% Northing-Easting with respect to HAV NE
X_E_local = [
    0,       0;
    794.169, 1015.547;
    798.003, 1003.576;
    296.655, 2688.395;
    2831.165, 2797.658;
    -1155.476, 1793.451;
    484.889, -1959.431;
    2285.391, 109.672;
    1594.833, -331.257;
    1218.471, 1292.777;
    1554.411, 1368.713;
    849.426, 1700.181;
    -2650.898, -10716.44;
    -8478.63, -7872.056;
    4332.912, -9321.267;
    -6612.391, 78.288;
    2842.167, 6858.899;
    4553.828, 2370.757;
    4393.398, -2040.09;
    3401.058, 10542.847;
    942.369, 1437.479
    ];

% N_heights
 f = [
    39.632,
    39.572;
    39.565;
    39.52;
    39.434;
    39.606;
    39.665;
    39.545;
    39.585;
    39.545;
    39.535;
    39.553;
    40.055;
    40.12;
    39.778;
    39.87;
    39.318;
    39.337;
    39.548;
    39.148;
    39.555;
];

A = [[ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00 0.00000000e+00  1.00000000e+00]
 [ 6.30704401e+05  8.06515945e+05  1.03133571e+06  7.94169000e+02 1.01554700e+03  1.00000000e+00]
 [ 6.36808788e+05  8.00856659e+05  1.00716479e+06  7.98003000e+02 1.00357600e+03  1.00000000e+00]
 [ 8.80041890e+04  7.97525819e+05  7.22746768e+06  2.96655000e+02 ...
   2.68839500e+03  1.00000000e+00]
 [ 8.01549526e+06  7.92063141e+06  7.82689029e+06  2.83116500e+03 ...
   2.79765800e+03  1.00000000e+00]
 [ 1.33512479e+06 -2.07228959e+06  3.21646649e+06 -1.15547600e+03 ...
   1.79345100e+03  1.00000000e+00]
 [ 2.35117342e+05 -9.50106538e+05  3.83936984e+06  4.84889000e+02 ...
  -1.95943100e+03  1.00000000e+00]
 [ 5.22301202e+06  2.50643402e+05  1.20279480e+04  2.28539100e+03 ...
   1.09672000e+02  1.00000000e+00]
 [ 2.54349230e+06 -5.28299595e+05  1.09731200e+05  1.59483300e+03 ...
  -3.31257000e+02  1.00000000e+00]
 [ 1.48467158e+06  1.57521128e+06  1.67127237e+06  1.21847100e+03 ...
   1.29277700e+03  1.00000000e+00]
 [ 2.41619356e+06  2.12754254e+06  1.87337528e+06  1.55441100e+03 ...
   1.36871300e+03  1.00000000e+00]
 [ 7.21524529e+05  1.44417795e+06  2.89061543e+06  8.49426000e+02 ...
   1.70018100e+03  1.00000000e+00]
 [ 7.02726021e+06  2.84081894e+07  1.14842086e+08 -2.65089800e+03 ...
  -1.07164400e+04  1.00000000e+00]
 [ 7.18871667e+07  6.67442502e+07  6.19692657e+07 -8.47863000e+03 ...
  -7.87205600e+03  1.00000000e+00]
 [ 1.87741264e+07 -4.03882296e+07  8.68860185e+07  4.33291200e+03 ...
  -9.32126700e+03  1.00000000e+00]
 [ 4.37237147e+07 -5.17670867e+05  6.12901100e+03 -6.61239100e+03 ...
   7.82880000e+01  1.00000000e+00]
 [ 8.07791326e+06  1.94941364e+07  4.70444955e+07  2.84216700e+03 ...
   6.85889900e+03  1.00000000e+00]
 [ 2.07373495e+07  1.07960196e+07  5.62048875e+06  4.55382800e+03 ...
   2.37075700e+03  1.00000000e+00]
 [ 1.93019460e+07 -8.96292733e+06  4.16196721e+06  4.39339800e+03 -2.04009000e+03  1.00000000e+00]
 [ 1.15671955e+07  3.58568341e+07  1.11151623e+08  3.40105800e+03 ...
   1.05428470e+04  1.00000000e+00]
 [ 8.88059332e+05  1.35463565e+06  2.06634588e+06  9.42369000e+02 ...
   1.43747900e+03  1.00000000e+00]];

P = [[1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4]];

A_transp = transpose(A);

At_P_A = A_transp*P*A;
At_P_f = A_transp*P*f;

% estimated coefficients
x_hat = (At_P_A) \ At_P_f;

v_hat = A*x_hat- f;

v_hat_transp = transpose(v_hat);

% Standard deviation with weight matrix P
sd_hat_0 = sqrt((v_hat_transp*P*v_hat)/(n-e));

% --- Standard deviations of the estimated heights --

% Cofactor Matrix
Q = inv(A_transp*P*A);

% Variance-Covariance Matrix of the estimated elements
C_hat = (sd_hat_0^2)*Q;

% standard deviations of coefficients
s_A  = sqrt(C_hat(1, 1));
s_B = sqrt(C_hat(2,2));
s_C = sqrt(C_hat(3,3));
s_D = sqrt(C_hat(4, 4));
s_E = sqrt(C_hat(5, 5));
s_F = sqrt(C_hat(6,6));

% t values of parameters
s_coeff = [s_A s_B s_C s_D s_E s_F];

t_coeff = abs(transpose(x_hat) ./ s_coeff);


% task c: Rate of deflections for one point
moh = [296.655, 2688.395];

% North Component, xi
xi = 2*x_hat(1)*moh(1) + x_hat(2)*moh(2) + x_hat(4);

% East Component, eta
eta = x_hat(2)*moh(1) + 2*x_hat(3)*moh(2) + x_hat(5);

% Geoid model heights for all given points
geoidHeightsModel1 = zeros(21,1);
for i = 1:21
    geoidHeightsModel1(i) = model1(X_E_local(i,1), X_E_local(i,2), x_hat);
end

% ellipsoidic heights from table in assignment text
h = [ 171.046, 110.338, 110.871, 170.838, 151.858, 122.725, 283.07,...
44.618, 149.094, 129.842, 82.84, 86.24, 142.935, 43.94, 67.708, 203.78, ...
59.958, 108.827, 83.958, 111.998, 87.616];

% orthometric heights from table in assignment
H_given = [
131.414
70.766
71.306
131.318
112.424
83.119
243.405
5.073
109.509
90.297
43.305
46.687
102.880
3.820
27.930
163.910
20.640
69.490
44.410
72.850
48.061
];

% orthmetric heights
H_est = transpose(h) - geoidHeightsModel1;

delta_H_est = H_est - H_given;

v_hatGeoid = geoidHeightsModel1 - f;


% Stanndard deviation of chosen geoid model
sd_hat_0 = sqrt((transpose(v_hatGeoid)*P*v_hatGeoid)/(n-e));
